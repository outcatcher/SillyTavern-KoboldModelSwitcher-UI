(()=>{"use strict";var e,t,n,o,i={56:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},66:(e,t,n)=>{n.d(t,{ER:()=>r,W8:()=>i,pW:()=>o});const o="KoboldModelSwitcher",i=" ",r=[256,512,1024,2048,3072,4096,6144,8192,10240,12288,14336,16384,20480,24576,28672,32768,40960,49152,57344,65536,81920,98304,114688,131072]},72:e=>{var t=[];function n(e){for(var n=-1,o=0;o<t.length;o++)if(t[o].identifier===e){n=o;break}return n}function o(e,o){for(var r={},a=[],s=0;s<e.length;s++){var l=e[s],c=o.base?l[0]+o.base:l[0],d=r[c]||0,u="".concat(c," ").concat(d);r[c]=d+1;var v=n(u),p={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==v)t[v].references++,t[v].updater(p);else{var f=i(p,o);o.byIndex=s,t.splice(s,0,{identifier:u,updater:f,references:1})}a.push(u)}return a}function i(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,i){var r=o(e=e||[],i=i||{});return function(e){e=e||[];for(var a=0;a<r.length;a++){var s=n(r[a]);t[s].references--}for(var l=o(e,i),c=0;c<r.length;c++){var d=n(r[c]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}r=l}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},156:(e,t,n)=>{n.a(e,(async(e,t)=>{try{n(511);var o=n(66),i=n(368),r=n(177),a=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{l(o.next(e))}catch(e){r(e)}}function s(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}l((o=o.apply(e,t||[])).next())}))};await function(){return a(this,void 0,void 0,(function*(){globalThis.console.debug(`[${o.pW}]`,"Initializing extension"),yield(0,r.b)(),yield(0,i.Ts)(),globalThis.console.debug(`[${o.pW}]`,"Extension initialized")}))}(),t()}catch(e){t(e)}}),1)},177:(e,t,n)=>{n.d(t,{b:()=>B});var o=n(66);const i=(e,t)=>{var n,o;const i=document.createElement("option");return i.value=e,i.innerText=null!==(n=null==t?void 0:t.text)&&void 0!==n?n:e,i.selected=null!==(o=null==t?void 0:t.selected)&&void 0!==o&&o,i};var r=n(368);const{saveSettingsDebounced:a}=SillyTavern.getContext(),s=Object.freeze({name:"",model:""}),l=Object.freeze({runTemplates:[]}),c=()=>{const e=SillyTavern.getContext().extensionSettings;return e[o.pW]||(e[o.pW]=structuredClone(l)),e[o.pW]},d=()=>{a()};var u=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{l(o.next(e))}catch(e){r(e)}}function s(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}l((o=o.apply(e,t||[])).next())}))};class v extends Error{constructor(e){super(`Timeout reached after ${e.toString()}ms`)}}const p=(e,t,n)=>u(void 0,void 0,void 0,(function*(){const o=()=>u(void 0,void 0,void 0,(function*(){var t;(yield e())||(yield(t=n,u(void 0,void 0,void 0,(function*(){return new Promise((e=>{setTimeout(e,t)}))}))),yield o())}));var i;yield Promise.race([o(),(i=t,u(void 0,void 0,void 0,(function*(){return new Promise(((e,t)=>{setTimeout(t,i)})).catch((()=>new v(i)))})))])}));var f=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{l(o.next(e))}catch(e){r(e)}}function s(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}l((o=o.apply(e,t||[])).next())}))};const{Popup:m,POPUP_TYPE:h}=SillyTavern.getContext(),y=()=>{var e;const t=c(),n=document.getElementById("run-templates");n.innerHTML="",t.runTemplates.forEach((e=>{n.options.add(i(e.name))})),n.value=null!==(e=t.selectedRunTemplate)&&void 0!==e?e:""},g=e=>{const t=!c().runTemplates.find((t=>t.name===e));return t||toastr.error("Template name already exists"),t},b=()=>f(void 0,void 0,void 0,(function*(){globalThis.console.info("Create popup created");const e=c(),t=new m("New run template name (UNIQUE)",h.INPUT,"",{okButton:"Create",cancelButton:"Cancel",wide:!0,onClosing:e=>g(e.value)});let n=yield t.show();n&&"string"==typeof n&&(e.runTemplates.find((e=>e.name===n))&&(n=`${n} (${Date.now().toString()})`),e.runTemplates.push(Object.assign(Object.assign({},s),{name:n})),d()),y()})),w=()=>f(void 0,void 0,void 0,(function*(){const e=c(),t=c().runTemplates.find((t=>t.name===e.selectedRunTemplate));if(void 0===e.selectedRunTemplate||void 0===t)return void(yield b());const n=new m("New run template name (UNIQUE)",h.INPUT,`${e.selectedRunTemplate} (copy)`,{okButton:"Create",cancelButton:"Cancel",wide:!0,onClosing:e=>g(e.value)});let o=yield n.show();o&&"string"==typeof o&&(e.runTemplates.find((e=>e.name===o))&&(o=`${o} (${Date.now().toString()})`),e.runTemplates.push(Object.assign(Object.assign({},t),{name:o})),d()),y()})),x=()=>f(void 0,void 0,void 0,(function*(){const e=document.getElementById("run-templates").value,t=c().runTemplates.find((t=>t.name===e));if(void 0===t)return void globalThis.console.error(`run template not found by name ${e}`);const n=yield(a=t,f(void 0,void 0,void 0,(function*(){var e,t,n,l,c,d,u,v,p;const f=new m('<div id="kobold-model-edit-template"> <div> <label for="model">Model Name</label> <select id="model" class="text_pole flex1"> </select> </div> <div> <label for="context-size">Context Size</label> <select id="context-size" class="text_pole flex1"> </select> </div> <div> <label for="gpu-layers">GPU Layers</label> <input type="number" id="gpu-layers" class="text_pole"/> </div> <div> <label for="threads">Threads</label> <input type="number" id="threads" class="text_pole" min="-1"/> </div> <div> <label for="tensor-split">Tensor split (space-separated list of floats)</label> <input type="text" id="tensor-split" class="text_pole"/> </div> </div> ',h.TEXT,"",{okButton:"Save",cancelButton:"Cancel",wide:!0,large:!0}).show(),y={modelSelect:document.getElementById("model"),contextSizeSelect:document.getElementById("context-size"),gpuLayers:document.getElementById("gpu-layers"),threads:document.getElementById("threads"),tensorSplit:document.getElementById("tensor-split")};o.ER.forEach((e=>{y.contextSizeSelect.appendChild(i(e.toString(),{selected:e===a.contextSize}))})),(yield(0,r.cy)()).forEach((e=>{y.modelSelect.appendChild(i(e,{selected:e===a.model}))}));const g=null!=a?a:s;return y.modelSelect.value=null!==(e=g.model)&&void 0!==e?e:"",y.modelSelect.onchange=()=>{g.model=y.modelSelect.value},y.contextSizeSelect.value=null!==(n=null===(t=g.contextSize)||void 0===t?void 0:t.toString())&&void 0!==n?n:"",y.contextSizeSelect.onchange=()=>{g.contextSize=parseInt(y.contextSizeSelect.value,10)},y.gpuLayers.value=null!==(c=null===(l=g.gpuLayers)||void 0===l?void 0:l.toString())&&void 0!==c?c:"",y.gpuLayers.onchange=()=>{g.gpuLayers=parseInt(y.gpuLayers.value,10)},y.threads.value=null!==(u=null===(d=g.threads)||void 0===d?void 0:d.toString())&&void 0!==u?u:"",y.threads.onchange=()=>{g.threads=parseInt(y.threads.value,10)},y.tensorSplit.value=null!==(p=null===(v=g.tensorSplit)||void 0===v?void 0:v.join(o.W8))&&void 0!==p?p:"",y.tensorSplit.onchange=()=>{g.tensorSplit=y.tensorSplit.value.split(o.W8).map((e=>parseInt(e,10)))},yield f.then((e=>e?g:a))})));var a;const l=c().runTemplates.findIndex((t=>t.name===e));c().runTemplates[l]=n,d(),y()})),S=()=>f(void 0,void 0,void 0,(function*(){var e;const t=c(),n=document.getElementById("run-templates"),o=new m(`Delete run template '${null!==(e=t.selectedRunTemplate)&&void 0!==e?e:""}'?`,h.CONFIRM,"",{okButton:"Delete",cancelButton:"Cancel",wide:!0});(yield o.show())&&(t.runTemplates=t.runTemplates.filter((e=>e.name!==n.value)),d(),y())})),T=e=>{c().selectedRunTemplate=e.target.value,d()},E=["loader"],k=["fa-play","active"],_=["fa-stop","redOverlayGlow"],I=e=>f(void 0,void 0,void 0,(function*(){const t=yield(0,r.E7)(),n={switcher:document.getElementById("kss-run-template-start"),status:document.getElementById("kss-current-status")},o="online"===t.status,i=o?_:k;n.switcher.onclick=e,n.switcher.classList.remove(...E,..._,...k),n.switcher.classList.add(...i);const a=o?["okText"]:["redOverlayGlow"],s=o?t.model:"All models are offline";n.status.classList.remove("enabled","redOverlayGlow"),n.status.classList.add(...a),n.status.innerHTML=`<h4>${s}</h4>`})),C=()=>f(void 0,void 0,void 0,(function*(){const e=c().selectedRunTemplate;if(void 0===e)return;(()=>{const e={switcher:document.getElementById("kss-run-template-start"),status:document.getElementById("kss-current-status")};e.switcher.onclick=null,e.switcher.classList.remove(..._,...k),e.switcher.classList.add(...E),e.status.classList.remove("enabled","redOverlayGlow"),e.status.classList.add("comment"),e.status.innerHTML="<h4>Loading...</h4>"})();const t=yield(0,r.E7)();switch(t.status){case"failed":case"offline":yield(n=e,o=C,f(void 0,void 0,void 0,(function*(){const e=c().runTemplates.find((e=>e.name===n));if(void 0===e)throw new Error(`can't find model ${n}`);yield(0,r.Mn)(e),p((()=>f(void 0,void 0,void 0,(function*(){const e=yield(0,r.E7)();return["online","failed"].includes(e.status)}))),12e4,2e3).then((()=>f(void 0,void 0,void 0,(function*(){yield I(o)})))).catch((()=>{toastr.error("Failed to wait for model status online/failed")}))}))).catch((e=>{toastr.error(e.message)}));break;case"online":yield(e=>f(void 0,void 0,void 0,(function*(){yield(0,r.kE)(),p((()=>f(void 0,void 0,void 0,(function*(){const e=yield(0,r.E7)();return["offline","failed"].includes(e.status)}))),1e4,100).then((()=>f(void 0,void 0,void 0,(function*(){yield I(e)})))).catch((()=>{toastr.error("Failed to wait for model status offline/failed")}))})))(C).catch((e=>{toastr.error(e.message)}));break;default:toastr.error(`Model ${t.model} currently in ${t.status} status`)}var n,o})),B=()=>f(void 0,void 0,void 0,(function*(){var e;const t=null!==(e=document.getElementById("kobold-switcher-container"))&&void 0!==e?e:document.getElementById("extensions_settings2");if(!t)return;const n=document.createElement("template");n.innerHTML='<div id="kobold-switcher-settings"> <div class="inline-drawer"> <div class="inline-drawer-toggle inline-drawer-header"> <b> <span>KoboldCpp Switcher</span> </b> <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div> </div> <div class="inline-drawer-content"> <label for="run-templates">Run template</label> <div class="flex-container flexnowrap"> <select id="run-templates" class="text_pole flex1"> </select> <div id="kss-run-template-start" class="menu_button fa-solid fa-play active interactable"></div> <div id="kss-run-template-edit" class="menu_button menu_button_icon interactable"> <i class="fa-solid fa-pen-to-square"></i> </div> <div id="kss-run-template-clone" class="menu_button menu_button_icon interactable"> <i class="fa-solid fa-clone"></i> </div> <div id="kss-run-template-create" class="menu_button menu_button_icon interactable"> <i class="fa-solid fa-plus"></i> </div> <div id="kss-run-template-delete" class="menu_button menu_button_icon interactable"> <i class="fa-solid fa-trash-can"></i> </div> </div> <label for="kss-current-status">Currently running model</label> <div class="flex-container flexnowrap"> <div id="kss-current-status" class="flex-container flexnowrap redOverlayGlow"> <h4>All models are offline</h4> </div> </div> </div> </div> </div> ',t.appendChild(n.content);const o={templatesSelect:document.getElementById("run-templates"),create:document.getElementById("kss-run-template-create"),clone:document.getElementById("kss-run-template-clone"),edit:document.getElementById("kss-run-template-edit"),delete:document.getElementById("kss-run-template-delete")};o.create.onclick=b,o.clone.onclick=w,o.edit.onclick=x,o.delete.onclick=S,o.templatesSelect.onchange=T,yield I(C),d(),y()}))},208:(e,t,n)=>{n.d(t,{A:()=>s});var o=n(601),i=n.n(o),r=n(314),a=n.n(r)()(i());a.push([e.id,".loader {\n    border-top: 16px solid #3498db; /* Blue */\n    border-radius: 50%;\n    animation: spin 1s linear infinite;\n}\n\n@keyframes spin {\n    0% {\n        transform: rotate(0deg);\n    }\n    100% {\n        transform: rotate(360deg);\n    }\n}\n\n.okText {\n    color: var(--customThemeColor);\n}\n",""]);const s=a},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",o=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),o&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),o&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,o,i,r){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(o)for(var s=0;s<this.length;s++){var l=this[s][0];null!=l&&(a[l]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);o&&a[d[0]]||(void 0!==r&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=r),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),i&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=i):d[4]="".concat(i)),t.push(d))}},t}},368:(e,t,n)=>{n.d(t,{E7:()=>d,Mn:()=>u,Ts:()=>l,cy:()=>c,kE:()=>v});var o=function(e,t,n,o){return new(n||(n=Promise))((function(i,r){function a(e){try{l(o.next(e))}catch(e){r(e)}}function s(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}l((o=o.apply(e,t||[])).next())}))};const i="/api/plugins/kobold-switcher/model";class r extends Error{}let a="";const s=()=>({"X-CSRF-Token":a,"Content-Type":"application/json"}),l=()=>o(void 0,void 0,void 0,(function*(){yield fetch("/csrf-token").then((e=>e.ok?e.json():Promise.reject(new Error(`requiest unsuccessfull, received code ${e.status.toString()} (${e.statusText})`)))).then((e=>{({token:a}=e)}))})),c=()=>o(void 0,void 0,void 0,(function*(){return yield fetch("/api/plugins/kobold-switcher/models").then((e=>e.ok?e.json():Promise.reject(new Error(`requiest unsuccessfull, received code ${e.status.toString()} (${e.statusText})`)))).then((e=>e.models))})),d=()=>o(void 0,void 0,void 0,(function*(){return yield fetch(i).then((e=>e.ok?e.json():Promise.reject(new Error(`requiest unsuccessfull, received code ${e.status.toString()} (${e.statusText})`))))})),u=e=>o(void 0,void 0,void 0,(function*(){yield fetch(i,{method:"PUT",headers:s(),body:JSON.stringify({model:e.model,contextSize:e.contextSize,gpuLayers:e.gpuLayers,threads:e.threads,tensorSplit:e.tensorSplit})}).then((e=>{if(!e.ok)throw new r(`got unexpected status code ${e.status.toString()}`)}))})),v=()=>o(void 0,void 0,void 0,(function*(){yield fetch(i,{method:"DELETE",headers:s()}).then((e=>{if(!e.ok)throw new r(`got unexpected status code ${e.status.toString()}`)}))}))},511:(e,t,n)=>{var o=n(72),i=n.n(o),r=n(825),a=n.n(r),s=n(659),l=n.n(s),c=n(56),d=n.n(c),u=n(540),v=n.n(u),p=n(113),f=n.n(p),m=n(208),h={};h.styleTagTransform=f(),h.setAttributes=d(),h.insert=l().bind(null,"head"),h.domAPI=a(),h.insertStyleElement=v();i()(m.A,h),m.A&&m.A.locals&&m.A.locals},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},601:e=>{e.exports=function(e){return e[1]}},659:e=>{var t={};e.exports=function(e,n){var o=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(n)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var o="";n.supports&&(o+="@supports (".concat(n.supports,") {")),n.media&&(o+="@media ".concat(n.media," {"));var i=void 0!==n.layer;i&&(o+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),o+=n.css,i&&(o+="}"),n.media&&(o+="}"),n.supports&&(o+="}");var r=n.sourceMap;r&&"undefined"!=typeof btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(r))))," */")),t.styleTagTransform(o,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}},r={};function a(e){var t=r[e];if(void 0!==t)return t.exports;var n=r[e]={id:e,exports:{}};return i[e](n,n.exports,a),n.exports}e="function"==typeof Symbol?Symbol("webpack queues"):"__webpack_queues__",t="function"==typeof Symbol?Symbol("webpack exports"):"__webpack_exports__",n="function"==typeof Symbol?Symbol("webpack error"):"__webpack_error__",o=e=>{e&&e.d<1&&(e.d=1,e.forEach((e=>e.r--)),e.forEach((e=>e.r--?e.r++:e())))},a.a=(i,r,a)=>{var s;a&&((s=[]).d=-1);var l,c,d,u=new Set,v=i.exports,p=new Promise(((e,t)=>{d=t,c=e}));p[t]=v,p[e]=e=>(s&&e(s),u.forEach(e),p.catch((e=>{}))),i.exports=p,r((i=>{var r;l=(i=>i.map((i=>{if(null!==i&&"object"==typeof i){if(i[e])return i;if(i.then){var r=[];r.d=0,i.then((e=>{a[t]=e,o(r)}),(e=>{a[n]=e,o(r)}));var a={};return a[e]=e=>e(r),a}}var s={};return s[e]=e=>{},s[t]=i,s})))(i);var a=()=>l.map((e=>{if(e[n])throw e[n];return e[t]})),c=new Promise((t=>{(r=()=>t(a)).r=0;var n=e=>e!==s&&!u.has(e)&&(u.add(e),e&&!e.d&&(r.r++,e.push(r)));l.map((t=>t[e](n)))}));return r.r?c:a()}),(e=>(e?d(p[n]=e):c(v),o(s)))),s&&s.d<0&&(s.d=0)},a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.nc=void 0;var s=a(156),l=exports,c=s.default;for(var d in c)l[d]=c[d];c.__esModule&&Object.defineProperty(l,"__esModule",{value:!0})})();